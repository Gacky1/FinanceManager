# Delete Transaction Implementation Guide

## What's Been Updated

### 1. Cloud Function (Backend)

**File**: `cloud-function-fixed.js`

Added a new `deleteTransaction` function that:
- Accepts DELETE requests
- Takes transaction ID as a query parameter
- Deletes the transaction from Cloud SQL
- Has CORS headers enabled

### 2. Frontend (script.js)

Updated to:
- **Store database ID**: When inserting, saves the `dbId` returned from the API
- **Call delete API**: When deleting, sends DELETE request to remove from database
- **Confirmation dialog**: Asks user to confirm before deleting
- **Better error handling**: Shows specific error messages

## Deployment Steps

### Step 1: Deploy the Delete Cloud Function

You need to create a **second Cloud Function** for deleting transactions.

#### Using Google Cloud Console:

1. Go to: https://console.cloud.google.com/functions
2. Click **"CREATE FUNCTION"**
3. Fill in the details:
   - **Function name**: `deleteTransaction`
   - **Region**: `asia-south1` (same as your insert function)
   - **Trigger**: HTTP
   - **Authentication**: Allow unauthenticated invocations
4. Click **"SAVE"** then **"NEXT"**
5. **Runtime**: Node.js 20
6. **Entry point**: `deleteTransaction`
7. In the code editor, paste the `deleteTransaction` function from `cloud-function-fixed.js`
8. Click **"DEPLOY"**

#### Using gcloud CLI:

```bash
# Create a new directory for the delete function
mkdir delete-transaction-function
cd delete-transaction-function

# Create index.js with the deleteTransaction code
# (Copy the deleteTransaction function from cloud-function-fixed.js)

# Create package.json
cat > package.json << EOF
{
  "name": "delete-transaction",
  "version": "1.0.0",
  "dependencies": {
    "mysql2": "^3.0.0"
  }
}
EOF

# Deploy
gcloud functions deploy deleteTransaction \
  --runtime nodejs20 \
  --trigger-http \
  --allow-unauthenticated \
  --region asia-south1 \
  --set-env-vars DB_USER=your_user,DB_PASS=your_pass,DB_NAME=your_db,INSTANCE_CONNECTION_NAME=your_instance
```

### Step 2: Get the Delete Function URL

After deployment, you'll get a URL like:
```
https://deletetransaction-505432234681.asia-south1.run.app/
```

### Step 3: Update Frontend with Correct URL

In `script.js`, line 196, make sure the URL matches your delete function URL:

```javascript
const response = await fetch(
  `https://deletetransaction-505432234681.asia-south1.run.app/?id=${dbId}`,
  // ^^^ Update this URL to match your actual delete function URL
  {
    method: "DELETE",
    headers: {
      "Content-Type": "application/json"
    }
  }
);
```

### Step 4: Update Insert Function

Also update your **insert function** to return the database ID:

Replace your current insert function with the updated one from `cloud-function-fixed.js` that includes:

```javascript
// Return the inserted ID so frontend can track it
res.status(200).json({ 
  message: "Transaction inserted successfully",
  id: result.insertId 
});
```

## How It Works Now

### Adding a Transaction:

1. User fills form and clicks "Add Transaction"
2. Frontend sends POST to insert API
3. Database inserts and returns auto-increment ID
4. Frontend stores both:
   - `id`: Local timestamp ID (for UI tracking)
   - `dbId`: Database ID (for deletion)
5. Transaction appears in UI

### Deleting a Transaction:

1. User clicks X button on a transaction
2. Confirmation dialog appears
3. If confirmed:
   - Frontend sends DELETE request with `dbId`
   - Database deletes the row
   - Frontend removes from local array
   - UI updates

## Testing

1. **Add a new transaction** - should save to database
2. **Check database** - verify it's there with an ID
3. **Click X to delete** - should show confirmation
4. **Confirm deletion** - should remove from UI
5. **Check database** - verify it's deleted

## Important Notes

### Database ID vs Local ID

- **Local ID (`id`)**: Generated by `Date.now()`, used for UI tracking
- **Database ID (`dbId`)**: Auto-increment from MySQL, used for deletion

### Old Transactions

Transactions added **before this update** won't have a `dbId`, so:
- They can still be deleted from the UI
- But they won't be deleted from the database
- This is okay - they'll just remain in the database

### Fresh Start Option

If you want a clean slate:

```sql
-- Clear all transactions
TRUNCATE TABLE transactions;
```

Then all new transactions will have proper `dbId` tracking.

## Troubleshooting

### "Error deleting from database"

**Check:**
1. Delete function is deployed
2. URL in script.js is correct
3. CORS headers are in the delete function
4. Database connection is working

### Delete works in UI but not database

**Check:**
1. Browser console for errors
2. Cloud Function logs
3. Transaction has a `dbId` (check localStorage)

### Confirmation dialog doesn't appear

**Check:**
- Browser is not blocking popups
- JavaScript console for errors

## Next Enhancement: Fetch Transactions

Currently, the app only shows transactions added in this session. To load existing transactions from the database, you would need:

1. **Fetch/List Cloud Function** to get all transactions
2. **Load on page start** to populate the UI
3. **Sync mechanism** to keep UI and database in sync

Let me know if you want me to implement this next!
